---
- name: Backup mongod.conf
  copy:
    src: /etc/mongod.conf
    dest: /etc/mongod.conf.bak
  ignore_errors: true

- name: Check if config contains deprecated journal option
  shell: grep -q "journal:" /etc/mongod.conf 2>/dev/null || echo "not_found"
  register: has_deprecated_journal
  changed_when: false
  failed_when: false

- name: Remove old config file if it contains deprecated option
  file:
    path: /etc/mongod.conf
    state: absent
  when: has_deprecated_journal.stdout != "not_found"

- name: Apply MongoDB configuration
  template:
    src: mongod.conf.j2
    dest: /etc/mongod.conf
  notify: Restart mongod

- name: Ensure keyfile directory exists
  file:
    path: "{{ keyfile_path | dirname }}"
    state: directory
    owner: mongodb
    group: mongodb
    mode: "0755"

- name: Generate keyfile on primary (cluster only)
  when: deployment_mode == "cluster" and "'primary' in group_names"
  shell: "openssl rand -base64 32 | head -c 64 > {{ keyfile_path }}"
  args:
    creates: "{{ keyfile_path }}"

- name: Set keyfile permissions
  file:
    path: "{{ keyfile_path }}"
    owner: mongodb
    group: mongodb
    mode: "0600"
  when: deployment_mode == "cluster"

- name: Restart MongoDB to apply configuration
  systemd:
    name: mongod
    state: restarted
  when: deployment_mode == "cluster"