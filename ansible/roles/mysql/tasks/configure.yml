---
- name: Backup original MySQL config
  copy:
    src: "{{ mysql_conf_path }}"
    dest: "{{ mysql_conf_path }}.bak"
    remote_src: true
  ignore_errors: true

- name: Apply custom MySQL configuration
  template:
    src: mysqld.cnf.j2
    dest: "{{ mysql_conf_path }}"
  notify: Restart MySQL

- name: Restart MySQL
  systemd:
    name: mysql
    state: restarted

- name: Ensure schemas and user exist
  mysql_db:
    name: "{{ item }}"
    state: present
  loop:
    - "{{ wolf_schema }}"
    - "{{ config_schema }}"

- name: Create application user
  mysql_user:
    name: "{{ mysql_user }}"
    password: "{{ mysql_password }}"
    host: "%"
    priv: "{{ wolf_schema }}.*:ALL,{{ config_schema }}.*:ALL"
    state: present
    login_user: "{{ mysql_root_user }}"
