---
- name: Check if credentials already exist
  stat:
    path: "{{ mongodb_credentials_path }}"
  register: creds_file

- name: Read existing credentials if file already exists
  when: creds_file.stat.exists
  slurp:
    src: "{{ mongodb_credentials_path }}"
  register: existing_creds

- name: Parse existing credentials
  when: creds_file.stat.exists
  set_fact:
    existing_mongodb_user: "{{ (existing_creds.content | b64decode | regex_search('MONGODB_ADMIN_USER=([A-Za-z0-9]+)', '\\1')) }}"
    existing_mongodb_password: "{{ (existing_creds.content | b64decode | regex_search('MONGODB_ADMIN_PASSWORD=([A-Za-z0-9]+)', '\\1')) }}"

- name: Determine whether to regenerate credentials
  set_fact:
    regenerate_mongodb_credentials: >-
      {{
        (not creds_file.stat.exists) or
        (existing_mongodb_user is not defined) or
        (existing_mongodb_password is not defined) or
        (existing_mongodb_user | length == 0) or
        (existing_mongodb_password | length == 0) or
        (existing_mongodb_user is not match('^[A-Za-z0-9]+$')) or
        (existing_mongodb_password is not match('^[A-Za-z0-9]+$'))
      }}

- name: Use existing credentials from file
  when: not regenerate_mongodb_credentials
  set_fact:
    admin_user: "{{ existing_mongodb_user }}"
    admin_password: "{{ existing_mongodb_password }}"

- name: Generate fresh MongoDB credentials
  when: regenerate_mongodb_credentials
  block:
    - name: Generate sanitized admin username
      set_fact:
        admin_user: "admin{{ lookup('password', '/dev/null chars=ascii_lowercase length=5') }}"

    - name: Generate sanitized admin password
      set_fact:
        admin_password: "{{ lookup('password', '/dev/null chars=ascii_letters+digits length=12') }}"

    - name: Persist MongoDB credentials to file
      copy:
        dest: "{{ mongodb_credentials_path }}"
        content: |
          MONGODB_ADMIN_USER={{ admin_user }}
          MONGODB_ADMIN_PASSWORD={{ admin_password }}
        owner: root
        group: root
        mode: "0600"

- name: Print credentials path info
  debug:
    msg:
      - "MongoDB credentials stored in: {{ mongodb_credentials_path }}"

- name: Display MongoDB credentials summary
  debug:
    msg: "CREDENTIALS|mongodb|username={{ admin_user }}|password={{ admin_password }}"