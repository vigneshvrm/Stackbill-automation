---
- name: Check if MySQL credentials file exists
  stat:
    path: "{{ mysql_credentials_path }}"
  register: creds_file

- name: Read existing credentials if file already exists
  when: creds_file.stat.exists
  slurp:
    src: "{{ mysql_credentials_path }}"
  register: creds_slurp

- name: Parse existing credentials
  when: creds_file.stat.exists
  set_fact:
    existing_mysql_user: "{{ (creds_slurp.content | b64decode | regex_search('MYSQL_USER=([A-Za-z0-9]+)', '\\1')) }}"
    existing_mysql_password: "{{ (creds_slurp.content | b64decode | regex_search('MYSQL_PASSWORD=([A-Za-z0-9]+)', '\\1')) }}"

- name: Determine whether to regenerate credentials
  set_fact:
    regenerate_mysql_credentials: >-
      {{
        (not creds_file.stat.exists) or
        (existing_mysql_user is not defined) or
        (existing_mysql_password is not defined) or
        (existing_mysql_user | length == 0) or
        (existing_mysql_password | length == 0) or
        (existing_mysql_user is not match('^[A-Za-z0-9]+$')) or
        (existing_mysql_password is not match('^[A-Za-z0-9]+$'))
      }}

- name: Use existing credentials from file
  when: not regenerate_mysql_credentials
  set_fact:
    mysql_user: "{{ existing_mysql_user }}"
    mysql_password: "{{ existing_mysql_password }}"

- name: Generate fresh MySQL credentials
  when: regenerate_mysql_credentials
  block:
    - name: Generate sanitized username
      set_fact:
        mysql_user: "stackbill{{ lookup('password', '/dev/null chars=ascii_lowercase length=4') }}"

    - name: Generate sanitized password
      set_fact:
        mysql_password: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=12') }}"

    - name: Persist sanitized credentials to file
      copy:
        dest: "{{ mysql_credentials_path }}"
        content: |
          MYSQL_USER={{ mysql_user }}
          MYSQL_PASSWORD={{ mysql_password }}
        owner: root
        group: root
        mode: '0600'

- name: Display MySQL credentials summary
  debug:
    msg: "CREDENTIALS|mysql|username={{ mysql_user }}|password={{ mysql_password }}"