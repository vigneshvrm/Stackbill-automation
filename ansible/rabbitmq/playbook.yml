---
- name: Install and configure RabbitMQ on Ubuntu 22.x+
  hosts: all
  become: true
  gather_facts: true

  pre_tasks:
    - name: Set custom hostname if provided
      hostname:
        name: "{{ custom_hostname }}"
      when: custom_hostname is defined and custom_hostname | length > 0

    - name: Update /etc/hosts with hostname
      lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1'
        line: "127.0.1.1 {{ custom_hostname }}"
        state: present
      when: custom_hostname is defined and custom_hostname | length > 0

    - name: Ensure host is Ubuntu 22.04 or greater
      assert:
        that:
          - ansible_facts['distribution'] == "Ubuntu"
          - ansible_facts['distribution_major_version'] | int >= 22
        fail_msg: "This playbook only supports Ubuntu 22.x or greater."
        success_msg: "Host meets Ubuntu version requirement."

  vars:
    creds_file: "/tmp/rabbitmq_credentials.txt"

  tasks:
    #####################################################################
    # üßπ Cleanup: Remove any legacy PackageCloud repositories
    #####################################################################
    - name: Remove legacy PackageCloud RabbitMQ repo definitions
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/apt/sources.list.d/rabbitmq.list
        - /etc/apt/sources.list.d/rabbitmq-erlang.list
        - /etc/apt/sources.list.d/packagecloud_io_rabbitmq_erlang.list
        - /etc/apt/sources.list.d/packagecloud_io_rabbitmq_server.list
      tags: ['cleanup']

    #####################################################################
    # üßæ Credentials Handling
    #####################################################################
    - name: Check if credentials file already exists
      stat:
        path: "{{ creds_file }}"
      register: creds_file_stat

    - name: Generate new credentials if not existing
      when: not creds_file_stat.stat.exists
      block:
        - name: Generate random username
          set_fact:
            rabbitmq_username: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=8') }}"
        - name: Generate random password
          set_fact:
            rabbitmq_password: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=12') }}"
        - name: Save credentials to file
          copy:
            dest: "{{ creds_file }}"
            content: |
              RABBITMQ_USER={{ rabbitmq_username }}
              RABBITMQ_PASS={{ rabbitmq_password }}
            owner: root
            group: root
            mode: '0600'
      tags: ['rabbitmq', 'creds']

    - name: Load existing credentials if file is present
      when: creds_file_stat.stat.exists
      shell: cat {{ creds_file }}
      register: creds_content
      changed_when: false

    - name: Parse credentials from file
      when: creds_file_stat.stat.exists
      set_fact:
        rabbitmq_username: "{{ (creds_content.stdout_lines[0].split('=')[1]) | regex_replace('[^A-Za-z0-9]', '') }}"
        rabbitmq_password: "{{ (creds_content.stdout_lines[1].split('=')[1]) | regex_replace('[^A-Za-z0-9]', '') }}"

    - name: Display RabbitMQ credentials (for logging)
      debug:
        msg: "CREDENTIALS|rabbitmq|username={{ rabbitmq_username }}|password={{ rabbitmq_password }}"
      tags: ['rabbitmq', 'creds']

    #####################################################################
    # üß± System Preparation
    #####################################################################
    - name: Update and upgrade system packages
      apt:
        update_cache: yes
        upgrade: dist
      tags: ['system', 'update']

    - name: Install required base packages and NFS client
      apt:
        name:
          - curl
          - gnupg
          - apt-transport-https
          - nfs-common
        state: present
      tags: ['packages']

    - name: Display NFS client installation status
      debug:
        msg: "NFS client (nfs-common) installed for StackBill file storage access"
      tags: ['packages']

    #####################################################################
    # ‚úÖ Official RabbitMQ Repository & Key Setup (Team RabbitMQ Repositories)
    # Based on official documentation: https://www.rabbitmq.com/docs/install-debian
    #####################################################################
    - name: Detect Ubuntu codename
      set_fact:
        ubuntu_codename: "{{ 'noble' if (ansible_facts['distribution_major_version']|int >= 24) else ('jammy' if (ansible_facts['distribution_major_version']|int >= 22) else 'focal') }}"
      when: ansible_facts['distribution'] == "Ubuntu"
    
    - name: Set default codename for non-Ubuntu systems
      set_fact:
        ubuntu_codename: "jammy"
      when: ansible_facts['distribution'] != "Ubuntu"
    
    - name: Add RabbitMQ and Erlang repositories securely
      block:
        - name: Check if signing key already exists
          stat:
            path: /usr/share/keyrings/com.rabbitmq.team.gpg
          register: keyfile_stat

        - name: Import Team RabbitMQ main signing key
          shell: curl -1sLf "https://keys.openpgp.org/vks/v1/by-fingerprint/0A9AF2115F4687BD29803A206B73A36E6026DFCA" | gpg --dearmor -o /usr/share/keyrings/com.rabbitmq.team.gpg
          when: not keyfile_stat.stat.exists

        - name: Configure RabbitMQ repositories (Team RabbitMQ official repositories)
          copy:
            dest: /etc/apt/sources.list.d/rabbitmq.list
            content: |
              ## Modern Erlang/OTP releases
              ##
              deb [arch=amd64 signed-by=/usr/share/keyrings/com.rabbitmq.team.gpg] https://deb1.rabbitmq.com/rabbitmq-erlang/ubuntu/{{ ubuntu_codename }} {{ ubuntu_codename }} main
              deb [arch=amd64 signed-by=/usr/share/keyrings/com.rabbitmq.team.gpg] https://deb2.rabbitmq.com/rabbitmq-erlang/ubuntu/{{ ubuntu_codename }} {{ ubuntu_codename }} main

              ## Latest RabbitMQ releases
              ##
              deb [arch=amd64 signed-by=/usr/share/keyrings/com.rabbitmq.team.gpg] https://deb1.rabbitmq.com/rabbitmq-server/ubuntu/{{ ubuntu_codename }} {{ ubuntu_codename }} main
              deb [arch=amd64 signed-by=/usr/share/keyrings/com.rabbitmq.team.gpg] https://deb2.rabbitmq.com/rabbitmq-server/ubuntu/{{ ubuntu_codename }} {{ ubuntu_codename }} main
            owner: root
            group: root
            mode: '0644'

        - name: Update apt cache after adding repositories
          apt:
            update_cache: yes
      tags: ['repo', 'keys']

    #####################################################################
    # üêá RabbitMQ Installation and Setup
    #####################################################################
    - name: Install Erlang packages (as per official documentation)
      apt:
        name:
          - erlang-base
          - erlang-asn1
          - erlang-crypto
          - erlang-eldap
          - erlang-ftp
          - erlang-inets
          - erlang-mnesia
          - erlang-os-mon
          - erlang-parsetools
          - erlang-public-key
          - erlang-runtime-tools
          - erlang-snmp
          - erlang-ssl
          - erlang-syntax-tools
          - erlang-tftp
          - erlang-tools
          - erlang-xmerl
        state: present
      tags: ['rabbitmq', 'install']

    - name: Install rabbitmq-server and its dependencies
      block:
        - name: Install rabbitmq-server package
          apt:
            name: rabbitmq-server
            state: present
            force_apt_get: yes
      rescue:
        - name: Attempt to fix broken dependencies
          command: apt-get install -f -y
          register: fix_broken_result
          changed_when: fix_broken_result.rc == 0
        - name: Retry installing rabbitmq-server package
          apt:
            name: rabbitmq-server
            state: present
            force_apt_get: yes
      tags: ['rabbitmq', 'install']

    - name: Enable and start RabbitMQ service
      systemd:
        name: rabbitmq-server
        enabled: yes
        state: started
      tags: ['rabbitmq', 'service']

    - name: Wait for RabbitMQ service to be ready (port 5672)
      wait_for:
        port: 5672
        delay: 5
        timeout: 60
      tags: ['rabbitmq', 'wait']

    - name: Enable RabbitMQ management plugin
      command: rabbitmq-plugins enable rabbitmq_management
      register: rabbitmq_plugin_enable_result
      changed_when: "'enabled' in rabbitmq_plugin_enable_result.stdout"
      tags: ['rabbitmq', 'plugin']

    - name: Enable all RabbitMQ feature flags
      command: rabbitmqctl enable_feature_flag all
      changed_when: false
      tags: ['rabbitmq']

    - name: Check if RabbitMQ user already exists
      command: rabbitmqctl list_users
      register: rabbitmq_users
      changed_when: false

    - name: Create RabbitMQ user if missing
      command: rabbitmqctl add_user {{ rabbitmq_username }} {{ rabbitmq_password }}
      when: rabbitmq_username not in rabbitmq_users.stdout
      register: rabbitmq_add_user
      retries: 5
      delay: 5
      until: rabbitmq_add_user.rc == 0
      tags: ['rabbitmq', 'user']

    - name: Set user as administrator
      command: rabbitmqctl set_user_tags {{ rabbitmq_username }} administrator
      register: rabbitmq_set_tag
      retries: 5
      delay: 5
      until: rabbitmq_set_tag.rc == 0
      tags: ['rabbitmq', 'user']

    - name: Set user permissions
      command: rabbitmqctl set_permissions -p / {{ rabbitmq_username }} ".*" ".*" ".*"
      register: rabbitmq_permissions
      retries: 5
      delay: 5
      until: rabbitmq_permissions.rc == 0
      tags: ['rabbitmq', 'user']

    #####################################################################
    # üìú Show Credentials
    #####################################################################
    - name: Display generated credentials
      debug:
        msg:
          - "RabbitMQ Username: {{ rabbitmq_username }}"
          - "RabbitMQ Password: {{ rabbitmq_password }}"
      tags: ['rabbitmq', 'creds']

  handlers:
    - name: Update apt cache
      apt:
        update_cache: yes
