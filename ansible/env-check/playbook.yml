---
# Environment Check Playbook
# Verifies network connectivity, firewall rules, and internet access for StackBill deployment

- name: Environment Preparation Check
  hosts: all
  become: true
  gather_facts: true

  pre_tasks:
    - name: Set custom hostname if provided
      hostname:
        name: "{{ custom_hostname }}"
      when: custom_hostname is defined and custom_hostname | length > 0

    - name: Update /etc/hosts with hostname
      lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1'
        line: "127.0.1.1 {{ custom_hostname }}"
        state: present
      when: custom_hostname is defined and custom_hostname | length > 0

  tasks:
    - name: Verify Ubuntu version
      ansible.builtin.assert:
        that:
          - ansible_distribution == "Ubuntu"
          - ansible_distribution_version is version('22.04', '>=')
        fail_msg: "This playbook requires Ubuntu 22.04 or later. Found: {{ ansible_distribution }} {{ ansible_distribution_version }}"
        success_msg: "OS Check Passed: {{ ansible_distribution }} {{ ansible_distribution_version }}"

    - name: Check system resources - CPU
      ansible.builtin.debug:
        msg: "CPU Cores: {{ ansible_processor_vcpus }}"

    - name: Check system resources - Memory
      ansible.builtin.debug:
        msg: "Total Memory: {{ (ansible_memtotal_mb / 1024) | round(2) }} GB"

    - name: Check system resources - Disk
      ansible.builtin.shell: df -h / | tail -1 | awk '{print $4}'
      register: disk_space
      changed_when: false

    - name: Display disk space
      ansible.builtin.debug:
        msg: "Available Disk Space: {{ disk_space.stdout }}"

    - name: Test internet connectivity - Google DNS
      ansible.builtin.command: ping -c 2 8.8.8.8
      register: ping_google
      changed_when: false
      failed_when: false

    - name: Verify internet access
      ansible.builtin.assert:
        that: ping_google.rc == 0
        fail_msg: "Internet connectivity check failed - Cannot reach Google DNS (8.8.8.8)"
        success_msg: "Internet connectivity verified"

    - name: Test DNS resolution
      ansible.builtin.command: nslookup google.com
      register: dns_check
      changed_when: false
      failed_when: false

    - name: Verify DNS resolution
      ansible.builtin.assert:
        that: dns_check.rc == 0
        fail_msg: "DNS resolution check failed"
        success_msg: "DNS resolution working"

    - name: Test access to StackBill S3 scripts repository
      ansible.builtin.uri:
        url: https://stacbilldeploy.s3.us-east-1.amazonaws.com/
        method: GET
        status_code: [200, 403]
        timeout: 10
      register: s3_check
      failed_when: false

    - name: Verify S3 repository access
      ansible.builtin.debug:
        msg: "{{ 'S3 Repository accessible' if s3_check.status in [200, 403] else 'WARNING: Cannot reach S3 repository' }}"

    - name: Check if firewall is active
      ansible.builtin.command: ufw status
      register: ufw_status
      changed_when: false
      failed_when: false

    - name: Display firewall status
      ansible.builtin.debug:
        msg: "Firewall Status: {{ ufw_status.stdout_lines[0] if ufw_status.stdout_lines else 'Unknown' }}"

    - name: Test port 22 (SSH) is listening
      ansible.builtin.wait_for:
        port: 22
        host: localhost
        timeout: 5
      failed_when: false

    - name: Check common required ports availability
      ansible.builtin.shell: |
        echo "Port Check Results:"
        for port in 22 80 443 6443 2379 2380 10250 10251 10252 27017 3306 5672 15672 2049; do
          if ss -tuln | grep -q ":$port "; then
            echo "Port $port: IN USE"
          else
            echo "Port $port: AVAILABLE"
          fi
        done
      register: port_check
      changed_when: false

    - name: Display port availability
      ansible.builtin.debug:
        msg: "{{ port_check.stdout_lines }}"

    - name: Wait for apt locks to be released
      ansible.builtin.shell: |
        while fuser /var/lib/dpkg/lock >/dev/null 2>&1 || \
              fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 || \
              fuser /var/lib/apt/lists/lock >/dev/null 2>&1; do
          echo "Waiting for apt locks (unattended-upgrades may be running)..."
          sleep 5
        done
      changed_when: false
      async: 300
      poll: 10

    - name: Verify apt package manager is working
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600
      register: apt_check

    - name: Test package installation capability
      ansible.builtin.apt:
        name: curl
        state: present
      register: curl_install

    - name: Summary - Environment Check Complete
      ansible.builtin.debug:
        msg:
          - "======================================"
          - "ENVIRONMENT CHECK SUMMARY"
          - "======================================"
          - "Host: {{ inventory_hostname }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "CPU: {{ ansible_processor_vcpus }} cores"
          - "Memory: {{ (ansible_memtotal_mb / 1024) | round(2) }} GB"
          - "Disk Available: {{ disk_space.stdout }}"
          - "Internet: {{ 'OK' if ping_google.rc == 0 else 'FAILED' }}"
          - "DNS: {{ 'OK' if dns_check.rc == 0 else 'FAILED' }}"
          - "S3 Access: {{ 'OK' if s3_check.status in [200, 403] else 'FAILED' }}"
          - "APT: {{ 'OK' if apt_check is success else 'FAILED' }}"
          - "======================================"
