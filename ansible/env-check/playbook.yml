---
# Environment Check Playbook
# Verifies network connectivity, firewall rules, and internet access for StackBill deployment

- name: Environment Preparation Check
  hosts: all
  become: true
  gather_facts: true

  pre_tasks:
    - name: Set custom hostname if provided
      hostname:
        name: "{{ custom_hostname }}"
      when: custom_hostname is defined and custom_hostname | length > 0

    - name: Update /etc/hosts with hostname
      lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1'
        line: "127.0.1.1 {{ custom_hostname }}"
        state: present
      when: custom_hostname is defined and custom_hostname | length > 0

  tasks:
    - name: Verify Ubuntu version
      ansible.builtin.assert:
        that:
          - ansible_distribution == "Ubuntu"
          - ansible_distribution_version is version('22.04', '>=')
        fail_msg: "This playbook requires Ubuntu 22.04 or later. Found: {{ ansible_distribution }} {{ ansible_distribution_version }}"
        success_msg: "OS Check Passed: {{ ansible_distribution }} {{ ansible_distribution_version }}"

    - name: Check system resources - CPU (minimum 2 cores)
      ansible.builtin.assert:
        that:
          - ansible_processor_vcpus >= 2
        fail_msg: "Insufficient CPU: {{ ansible_processor_vcpus }} cores (minimum 2 required)"
        success_msg: "CPU Check Passed: {{ ansible_processor_vcpus }} cores"

    - name: Check system resources - Memory (minimum 4GB)
      ansible.builtin.assert:
        that:
          - ansible_memtotal_mb >= 3800
        fail_msg: "Insufficient Memory: {{ (ansible_memtotal_mb / 1024) | round(2) }} GB (minimum 4GB required)"
        success_msg: "Memory Check Passed: {{ (ansible_memtotal_mb / 1024) | round(2) }} GB"

    - name: Get available disk space
      ansible.builtin.shell: df -BG / | tail -1 | awk '{print $4}' | tr -d 'G'
      register: disk_space_gb
      changed_when: false

    - name: Check system resources - Disk (minimum 20GB free)
      ansible.builtin.assert:
        that:
          - disk_space_gb.stdout | int >= 20
        fail_msg: "Insufficient Disk Space: {{ disk_space_gb.stdout }}GB free (minimum 20GB required)"
        success_msg: "Disk Check Passed: {{ disk_space_gb.stdout }}GB free"

    - name: Test internet connectivity
      ansible.builtin.command: ping -c 2 8.8.8.8
      register: ping_google
      changed_when: false
      failed_when: ping_google.rc != 0

    - name: Test access to StackBill S3 repository
      ansible.builtin.uri:
        url: https://stacbilldeploy.s3.us-east-1.amazonaws.com/
        method: GET
        status_code: [200, 403]
        timeout: 10
      register: s3_check

    - name: Check if firewall is active
      ansible.builtin.command: ufw status
      register: ufw_status
      changed_when: false
      failed_when: false

    - name: Check common required ports availability
      ansible.builtin.shell: |
        echo "Port Check Results:"
        for port in 22 80 443 6443 2379 2380 10250 10251 10252 27017 3306 5672 15672 2049; do
          if ss -tuln | grep -q ":$port "; then
            echo "Port $port: IN USE"
          else
            echo "Port $port: AVAILABLE"
          fi
        done
      register: port_check
      changed_when: false

    - name: Stop unattended-upgrades service
      ansible.builtin.service:
        name: unattended-upgrades
        state: stopped
      failed_when: false

    - name: Kill processes holding apt locks
      ansible.builtin.shell: |
        # Kill unattended-upgrades if running
        pkill -9 unattended-upgr || true
        pkill -9 apt.systemd.daily || true

        # Wait and kill any process holding apt locks
        for lock in /var/lib/dpkg/lock /var/lib/dpkg/lock-frontend /var/lib/apt/lists/lock /var/cache/apt/archives/lock; do
          if [ -f "$lock" ]; then
            pid=$(fuser "$lock" 2>/dev/null | awk '{print $1}')
            if [ -n "$pid" ]; then
              echo "Killing process $pid holding $lock"
              kill -9 $pid 2>/dev/null || true
            fi
          fi
        done

        # Remove stale lock files
        rm -f /var/lib/dpkg/lock /var/lib/dpkg/lock-frontend /var/lib/apt/lists/lock /var/cache/apt/archives/lock 2>/dev/null || true

        # Fix dpkg if interrupted
        dpkg --configure -a 2>/dev/null || true

        sleep 2
      changed_when: false
