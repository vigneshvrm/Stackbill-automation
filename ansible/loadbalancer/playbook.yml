---
# Load Balancer Installation Playbook
# Configures HAProxy or Nginx as a reverse proxy/load balancer for StackBill
# The load balancer terminates SSL and proxies to Kubernetes Ingress

- name: Install and configure Load Balancer
  hosts: all
  become: true
  gather_facts: true

  vars:
    lb_type: "{{ load_balancer_type | default('haproxy') }}"  # haproxy or nginx
    lb_frontend_port: "{{ frontend_port | default('443') }}"
    lb_backend_port: "{{ backend_port | default('30080') }}"  # NodePort on K8s
    domain_name: "{{ stackbill_domain | default('stackbill.local') }}"
    # SSL configuration
    ssl_type: "{{ ssl_certificate_type | default('letsencrypt') }}"  # letsencrypt, upload, or self-signed
    ssl_fullchain: "{{ fullchain_certificate | default('') }}"
    ssl_privkey: "{{ private_key | default('') }}"
    # SSL paths - use domain name for directory
    ssl_dir: "/etc/ssl/{{ domain_name }}"
    ssl_cert_path: "{{ ssl_dir }}/fullchain.pem"
    ssl_key_path: "{{ ssl_dir }}/privkey.pem"
    ssl_combined_path: "{{ ssl_dir }}/{{ domain_name }}.pem"

  pre_tasks:
    - name: Set custom hostname if provided
      hostname:
        name: "{{ custom_hostname }}"
      when: custom_hostname is defined and custom_hostname | length > 0

    - name: Update /etc/hosts with hostname
      lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1'
        line: "127.0.1.1 {{ custom_hostname }}"
        state: present
      when: custom_hostname is defined and custom_hostname | length > 0

    - name: Verify Ubuntu version
      assert:
        that:
          - ansible_distribution == "Ubuntu"
          - ansible_distribution_version is version('22.04', '>=')
        fail_msg: "This playbook requires Ubuntu 22.04 or later"
        success_msg: "OS verification passed: {{ ansible_distribution }} {{ ansible_distribution_version }}"

  tasks:
    #####################################################################
    # Common Setup
    #####################################################################
    - name: Create SSL directory
      file:
        path: "{{ ssl_dir }}"
        state: directory
        mode: '0755'

    - name: Install common packages
      apt:
        name:
          - curl
          - openssl
          - nfs-common
        state: present
        update_cache: yes

    #####################################################################
    # SSL Certificate Setup - Let's Encrypt
    #####################################################################
    - name: Configure Let's Encrypt certificate
      when: ssl_type == 'letsencrypt'
      block:
        - name: Install Certbot
          apt:
            name: certbot
            state: present
            update_cache: yes

        - name: Check if Let's Encrypt certificate already exists
          stat:
            path: "/etc/letsencrypt/live/{{ domain_name }}/fullchain.pem"
          register: letsencrypt_cert

        - name: Stop HAProxy temporarily for certbot (if running)
          systemd:
            name: haproxy
            state: stopped
          failed_when: false
          when: not letsencrypt_cert.stat.exists

        - name: Obtain Let's Encrypt certificate (standalone mode)
          command: >
            certbot certonly --standalone
            -d {{ domain_name }}
            --non-interactive
            --agree-tos
            --email admin@{{ domain_name }}
          register: certbot_result
          when: not letsencrypt_cert.stat.exists

        - name: Copy Let's Encrypt certificate files
          copy:
            src: "/etc/letsencrypt/live/{{ domain_name }}/{{ item.src }}"
            dest: "{{ ssl_dir }}/{{ item.dest }}"
            remote_src: yes
            mode: "{{ item.mode }}"
          loop:
            - { src: 'privkey.pem', dest: 'privkey.pem', mode: '0600' }
            - { src: 'fullchain.pem', dest: 'fullchain.pem', mode: '0644' }

        - name: Create combined PEM for HAProxy (Let's Encrypt)
          shell: cat {{ ssl_cert_path }} {{ ssl_key_path }} > {{ ssl_combined_path }}

        - name: Set permissions on combined PEM
          file:
            path: "{{ ssl_combined_path }}"
            mode: '0600'

    #####################################################################
    # SSL Certificate Setup - Upload Custom Certificate
    #####################################################################
    - name: Configure uploaded SSL certificates
      when: ssl_type == 'upload'
      block:
        - name: Validate fullchain certificate provided
          assert:
            that:
              - ssl_fullchain | length > 0
            fail_msg: "Fullchain certificate content is required for upload type"

        - name: Validate private key provided
          assert:
            that:
              - ssl_privkey | length > 0
            fail_msg: "Private key content is required for upload type"

        - name: Write fullchain certificate
          copy:
            content: "{{ ssl_fullchain }}"
            dest: "{{ ssl_cert_path }}"
            mode: '0644'

        - name: Write private key
          copy:
            content: "{{ ssl_privkey }}"
            dest: "{{ ssl_key_path }}"
            mode: '0600'

        - name: Create combined PEM for HAProxy (uploaded)
          shell: cat {{ ssl_cert_path }} {{ ssl_key_path }} > {{ ssl_combined_path }}

        - name: Set permissions on combined PEM
          file:
            path: "{{ ssl_combined_path }}"
            mode: '0600'

    #####################################################################
    # SSL Certificate Setup - Self-signed (fallback)
    #####################################################################
    - name: Generate self-signed SSL certificate
      when: ssl_type == 'self-signed' or (ssl_type != 'letsencrypt' and ssl_type != 'upload')
      block:
        - name: Check if certificate already exists
          stat:
            path: "{{ ssl_combined_path }}"
          register: ssl_cert_check

        - name: Generate self-signed certificate
          when: not ssl_cert_check.stat.exists
          block:
            - name: Generate private key
              openssl_privatekey:
                path: "{{ ssl_key_path }}"
                size: 2048
                mode: '0600'

            - name: Generate CSR
              openssl_csr:
                path: "{{ ssl_dir }}/{{ domain_name }}.csr"
                privatekey_path: "{{ ssl_key_path }}"
                common_name: "{{ domain_name }}"
                subject_alt_name:
                  - "DNS:{{ domain_name }}"
                  - "DNS:*.{{ domain_name }}"

            - name: Generate self-signed certificate
              openssl_certificate:
                path: "{{ ssl_cert_path }}"
                privatekey_path: "{{ ssl_key_path }}"
                csr_path: "{{ ssl_dir }}/{{ domain_name }}.csr"
                provider: selfsigned
                selfsigned_not_after: "+365d"
                mode: '0644'

            - name: Create combined PEM file for HAProxy
              shell: cat {{ ssl_cert_path }} {{ ssl_key_path }} > {{ ssl_combined_path }}

            - name: Set permissions on combined PEM
              file:
                path: "{{ ssl_combined_path }}"
                mode: '0600'

    #####################################################################
    # HAProxy Installation (Default)
    #####################################################################
    - name: Install and configure HAProxy
      when: lb_type == 'haproxy'
      block:
        - name: Install HAProxy
          apt:
            name: haproxy
            state: present

        - name: Create HAProxy configuration
          template:
            src: haproxy.cfg.j2
            dest: /etc/haproxy/haproxy.cfg
            mode: '0644'
            backup: yes
          notify: Restart HAProxy

        - name: Enable HAProxy service
          systemd:
            name: haproxy
            enabled: true
            state: started

    #####################################################################
    # Nginx Installation (Alternative)
    #####################################################################
    - name: Install and configure Nginx
      when: lb_type == 'nginx'
      block:
        - name: Install Nginx
          apt:
            name: nginx
            state: present

        - name: Create Nginx configuration
          template:
            src: nginx.conf.j2
            dest: /etc/nginx/sites-available/stackbill
            mode: '0644'
            backup: yes
          notify: Restart Nginx

        - name: Enable Nginx site
          file:
            src: /etc/nginx/sites-available/stackbill
            dest: /etc/nginx/sites-enabled/stackbill
            state: link
          notify: Restart Nginx

        - name: Remove default Nginx site
          file:
            path: /etc/nginx/sites-enabled/default
            state: absent
          notify: Restart Nginx

        - name: Enable Nginx service
          systemd:
            name: nginx
            enabled: true
            state: started

    #####################################################################
    # Display Configuration Info
    #####################################################################
    #####################################################################
    # Output Credentials
    #####################################################################
    - name: Output SSL credentials
      debug:
        msg:
          - "CREDENTIALS|ssl|type={{ ssl_type }}"
          - "CREDENTIALS|ssl|domain={{ domain_name }}"
          - "CREDENTIALS|ssl|private_key={{ ssl_key_path }}"
          - "CREDENTIALS|ssl|certificate={{ ssl_cert_path }}"
          - "CREDENTIALS|ssl|combined_pem={{ ssl_combined_path }}"

    #####################################################################
    # Display Configuration Info
    #####################################################################
    - name: Display load balancer configuration
      debug:
        msg:
          - "======================================"
          - "LOAD BALANCER INSTALLATION COMPLETE"
          - "======================================"
          - "Load Balancer Type: {{ lb_type | upper }}"
          - "Frontend Port: {{ lb_frontend_port }}"
          - "Backend Port: {{ lb_backend_port }}"
          - "Domain: {{ domain_name }}"
          - ""
          - "SSL Configuration:"
          - "  Type: {{ ssl_type | upper }}"
          - "  Certificate: {{ ssl_cert_path }}"
          - "  Private Key: {{ ssl_key_path }}"
          - "  Combined PEM: {{ ssl_combined_path }}"
          - ""
          - "Next Steps:"
          - "1. Point DNS for {{ domain_name }} to this server"
          - "2. Ensure K8s Ingress NodePort is {{ lb_backend_port }}"
          - "======================================"

  handlers:
    - name: Restart HAProxy
      systemd:
        name: haproxy
        state: restarted

    - name: Restart Nginx
      systemd:
        name: nginx
        state: restarted
