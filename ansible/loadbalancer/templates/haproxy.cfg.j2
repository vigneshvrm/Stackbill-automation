# HAProxy Configuration for StackBill
# Generated by Ansible

global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

    # SSL Settings
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  forwardfor
    option  http-server-close
    timeout connect 5000
    timeout client  50000
    timeout server  50000
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# Statistics Page
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if LOCALHOST

# HTTP Frontend (Redirect to HTTPS)
frontend http_front
    bind *:80
    mode http
    # ACME challenge for Let's Encrypt
    acl letsencrypt-acme path_beg /.well-known/acme-challenge/
    use_backend letsencrypt if letsencrypt-acme
    # Redirect all other HTTP to HTTPS
    redirect scheme https code 301 if !{ ssl_fc } !letsencrypt-acme

# HTTPS Frontend
frontend https_front
    bind *:{{ lb_frontend_port }} ssl crt /etc/ssl/stackbill/stackbill.pem alpn h2,http/1.1
    mode http

    # Security Headers
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    http-response set-header X-Frame-Options "SAMEORIGIN"
    http-response set-header X-Content-Type-Options "nosniff"
    http-response set-header X-XSS-Protection "1; mode=block"

    # Default backend
    default_backend k8s_ingress

# Kubernetes Ingress Backend
backend k8s_ingress
    mode http
    balance roundrobin
    option httpchk GET /healthz
    http-check expect status 200
{% if backend_servers is defined and backend_servers %}
{% for server in backend_servers.split(',') %}
    server k8s-{{ loop.index }} {{ server }}:{{ lb_backend_port }} check
{% endfor %}
{% else %}
    # Add your Kubernetes worker node IPs here
    # server k8s-worker-1 192.168.1.11:{{ lb_backend_port }} check
    # server k8s-worker-2 192.168.1.12:{{ lb_backend_port }} check
{% endif %}

# Let's Encrypt ACME challenge backend
backend letsencrypt
    mode http
    server letsencrypt 127.0.0.1:8888
